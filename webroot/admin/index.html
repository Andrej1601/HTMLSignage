 <!doctype html> <html lang="de"> <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aufguss ‚Äì Admin</title>
<link rel="stylesheet" href="/admin/css/admin.css">

</head>
<body class="theme-light">
  <header>
    <div class="header-title">
      <h1>Anzeigensteuerung ‚Äì Admin</h1>
      <label class="toggle" title="Hell/Dunkel">
        <input type="checkbox" id="themeMode">
        <svg class="sun" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="4" fill="currentColor"/>
          <g stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="12" y1="2" x2="12" y2="4"/>
            <line x1="12" y1="20" x2="12" y2="22"/>
            <line x1="4.93" y1="4.93" x2="6.34" y2="6.34"/>
            <line x1="17.66" y1="17.66" x2="19.07" y2="19.07"/>
            <line x1="2" y1="12" x2="4" y2="12"/>
            <line x1="20" y1="12" x2="22" y2="12"/>
            <line x1="4.93" y1="19.07" x2="6.34" y2="17.66"/>
            <line x1="17.66" y1="6.34" x2="19.07" y2="4.93"/>
          </g>
        </svg>
        <svg class="moon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/>
        </svg>
      </label>
    </div>
    <div class="header-actions">
      <!-- Ansicht-Men√º -->
      <button class="btn" id="btnDevices">Ger√§te</button>
      <div class="menuwrap" id="viewMenuWrap">
        <button class="btn" id="viewMenuBtn" aria-haspopup="menu" aria-expanded="false">
          Ansicht: <span id="viewMenuLabel">Grid</span> ‚ñæ
        </button>
        <div class="dropdown" id="viewMenu" role="menu" hidden>
          <button class="dd-item" role="menuitemradio" data-view="grid" aria-checked="true">‚ñ¶ Grid</button>
          <button class="dd-item" role="menuitemradio" data-view="preview" aria-checked="false">‚ñ∂ Vorschau</button>
        </div>
      </div>
      <button class="btn" id="btnHelp">Hilfe</button>
      <button class="btn" id="btnOpen">Slideshow √∂ffnen</button>
      <button class="btn primary" id="btnSave">Speichern</button>
      <span id="unsavedBadge" class="unsaved-badge" hidden role="status" aria-live="polite">
        <span class="unsaved-badge-text">√Ñnderungen nicht gespeichert</span>
        <button type="button" class="unsaved-badge-btn" id="unsavedBadgeReset" aria-label="√Ñnderungen verwerfen">‚ü≥</button>
      </span>
    </div>
  </header>

  <main class="layout">
    <section class="workspace-overview" aria-labelledby="adminCockpitTitle" data-collapsed="false" data-pinned="false">
      <header class="workspace-toolbar">
        <h2 id="adminCockpitTitle" class="workspace-title">Admin-Cockpit</h2>
        <div class="workspace-toolbar-actions" role="group" aria-label="Cockpit-Optionen">
          <button type="button" class="workspace-tool-btn" data-action="pin" aria-pressed="false" title="Cockpit anheften">
            <span class="workspace-tool-icon" data-role="icon" data-icon-pinned="üìç" data-icon-unpinned="üìå" aria-hidden="true">üìå</span>
            <span class="workspace-tool-label" data-role="label" data-label-pinned="L√∂sen" data-label-unpinned="Anheften">Anheften</span>
          </button>
          <button type="button" class="workspace-tool-btn" data-action="toggle" aria-controls="adminCockpitBody" aria-expanded="true" title="Cockpit minimieren">
            <span class="workspace-tool-icon" data-role="icon" data-icon-expanded="‚ñæ" data-icon-collapsed="‚ñ∏" aria-hidden="true">‚ñæ</span>
            <span class="workspace-tool-label" data-role="label" data-label-expanded="Einklappen" data-label-collapsed="Aufklappen">Einklappen</span>
          </button>
        </div>
      </header>

      <div class="workspace-body" id="adminCockpitBody">
        <div class="workspace-grid" role="list">
          <article class="workspace-card" role="listitem">
            <div class="workspace-card-head">
              <span class="workspace-card-icon" aria-hidden="true">üñ•Ô∏è</span>
              <div>
                <h3>Vorschau &amp; Ger√§te</h3>
                <p>Slides live pr√ºfen, Ger√§te verwalten und Anzeigen aktualisieren.</p>
              </div>
            </div>
            <ul class="workspace-card-list">
              <li>Slideshow in der Vorschau kontrollieren</li>
              <li>Ger√§testatus, Firmware und Pairings im Blick behalten</li>
              <li>Displays neu laden oder Ger√§te koppeln</li>
            </ul>
            <div class="workspace-card-actions">
              <div class="workspace-card-actions-main">
                <button type="button" class="workspace-card-btn primary" data-view="preview" data-highlight="dockPane">Vorschau √∂ffnen</button>
              </div>
              <div class="workspace-card-branches" role="group" aria-label="Ger√§teverwaltung">
                <button type="button" class="workspace-branch-btn" data-devices="open" data-highlight="devicesPane">Ger√§tebereich</button>
                <button type="button" class="workspace-branch-btn" data-devices="refresh" data-highlight="devicesPane">Status aktualisieren</button>
              </div>
            </div>
          </article>

          <article class="workspace-card" role="listitem">
            <div class="workspace-card-head">
              <span class="workspace-card-icon" aria-hidden="true">üóìÔ∏è</span>
              <div>
                <h3>Tagesplan &amp; Wochenablauf</h3>
                <p>Zeiten strukturieren, Reihenfolge anpassen und Wochenvorlagen sichern.</p>
              </div>
            </div>
            <ul class="workspace-card-list">
              <li>Zeiten verschieben, duplizieren oder l√∂schen</li>
              <li>Wochentage vergleichen und speichern</li>
              <li>Schnell zu freien Slots navigieren</li>
            </ul>
            <div class="workspace-card-actions">
              <div class="workspace-card-actions-main">
                <button type="button" class="workspace-card-btn primary" data-view="grid" data-jump="gridPane" aria-controls="gridPane">Plan bearbeiten</button>
              </div>
            </div>
          </article>

          <article class="workspace-card" role="listitem">
            <div class="workspace-card-head">
              <span class="workspace-card-icon" aria-hidden="true">üî•</span>
              <div>
                <h3>Saunen &amp; Hinweise</h3>
                <p>Saunen, Fu√ünoten und Badge-Bibliothek pflegen ‚Äì inklusive Vorschau und Reihenfolge.</p>
              </div>
            </div>
            <ul class="workspace-card-list">
              <li>Saunen aktivieren/deaktivieren</li>
              <li>Badges und Hinweise verwalten</li>
              <li>√úbersicht f√ºr den Aufgussplan anpassen</li>
            </ul>
            <div class="workspace-card-actions">
              <div class="workspace-card-actions-main">
                <button type="button" class="workspace-card-btn primary" data-jump="boxSaunas" aria-controls="boxSaunas">Saunen √∂ffnen</button>
              </div>
              <div class="workspace-card-branches" role="group" aria-label="Weitere Bereiche">
                <button type="button" class="workspace-branch-btn" data-jump="boxFootnotes" aria-controls="boxFootnotes">Fu√ünoten &amp; Badges</button>
                <button type="button" class="workspace-branch-btn" data-jump="badgeLibrarySection" aria-controls="badgeLibrarySection">Badge-Bibliothek</button>
              </div>
            </div>
          </article>

          <article class="workspace-card" role="listitem">
            <div class="workspace-card-head">
              <span class="workspace-card-icon" aria-hidden="true">üé¨</span>
              <div>
                <h3>Slides &amp; Automationen</h3>
                <p>Dauer, √úberg√§nge und Reihenfolgen einstellen, damit der Ablauf passt.</p>
              </div>
            </div>
            <ul class="workspace-card-list">
              <li>Globale oder individuelle Slide-Dauer w√§hlen</li>
              <li>Automatisierungen aktivieren</li>
              <li>√úbersichten &amp; Vorschauen pr√ºfen</li>
            </ul>
            <div class="workspace-card-actions">
              <div class="workspace-card-actions-main">
                <button type="button" class="workspace-card-btn primary" data-jump="slidesMaster" aria-controls="slidesMaster">Ablauf steuern</button>
              </div>
              <div class="workspace-card-branches" role="group" aria-label="Weitere Einstellungen">
                <button type="button" class="workspace-branch-btn" data-jump="slidesFlowCard" aria-controls="slidesFlowCard">Zeitsteuerung</button>
                <button type="button" class="workspace-branch-btn" data-jump="slidesAutomationCard" aria-controls="slidesAutomationCard">Automatisierung</button>
              </div>
            </div>
          </article>

          <article class="workspace-card" role="listitem">
            <div class="workspace-card-head">
              <span class="workspace-card-icon" aria-hidden="true">üñºÔ∏è</span>
              <div>
                <h3>Infos &amp; Story-Slides</h3>
                <p>Zusatzinhalte, Countdowns, Wellness-Tipps und Story-Baukasten betreuen.</p>
              </div>
            </div>
            <ul class="workspace-card-list">
              <li>Wellness-, Gastro- und Eventinfos pflegen</li>
              <li>Hero-Timeline aktivieren und timen</li>
              <li>Story-Slides mit Spalten-Baukasten gestalten</li>
            </ul>
            <div class="workspace-card-actions">
              <div class="workspace-card-actions-main">
                <button type="button" class="workspace-card-btn primary" data-jump="boxStories" aria-controls="boxStories">Zusatzinfos</button>
              </div>
              <div class="workspace-card-branches" role="group" aria-label="Direkte Abschnitte">
                <button type="button" class="workspace-branch-btn" data-jump="infoWellness" aria-controls="infoWellness">Wellness-Tipps</button>
                <button type="button" class="workspace-branch-btn" data-jump="infoEvents" aria-controls="infoEvents">Event-Countdowns</button>
                <button type="button" class="workspace-branch-btn" data-jump="infoGastro" aria-controls="infoGastro">Gastro-Infos</button>
                <button type="button" class="workspace-branch-btn" data-jump="infoHero" aria-controls="infoHero">Hero-Timeline</button>
                <button type="button" class="workspace-branch-btn" data-jump="infoStories" aria-controls="infoStories">Story-Slides</button>
              </div>
            </div>
          </article>

          <article class="workspace-card" role="listitem">
            <div class="workspace-card-head">
              <span class="workspace-card-icon" aria-hidden="true">üé®</span>
              <div>
                <h3>Medien &amp; Layout</h3>
                <p>Slides mit Bildern, Texten, Farben und Layouts gestalten ‚Äì inklusive Presets.</p>
              </div>
            </div>
            <ul class="workspace-card-list">
              <li>Medien-Slides verwalten und sortieren</li>
              <li>Layouts f√ºr Splitscreens und Anzeigearten festlegen</li>
              <li>Style-Presets pflegen und anwenden</li>
            </ul>
            <div class="workspace-card-actions">
              <div class="workspace-card-actions-main">
                <button type="button" class="workspace-card-btn primary" data-jump="boxImages" aria-controls="boxImages">Medienbereich</button>
              </div>
              <div class="workspace-card-branches" role="group" aria-label="Layout &amp; Styles">
                <button type="button" class="workspace-branch-btn" data-jump="boxSlidesText" aria-controls="boxSlidesText">Slideshow &amp; Text</button>
                <button type="button" class="workspace-branch-btn" data-jump="displayLayoutFold" aria-controls="displayLayoutFold">Darstellung &amp; Seiten</button>
                <button type="button" class="workspace-branch-btn" data-jump="styleSetControls" aria-controls="styleSetControls">Style-Paletten</button>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>

    <section class="leftcol">
<div class="card" id="gridPane" data-jump-target>
        <div class="content" style="padding-bottom:0">
<div class="row" id="planHead" style="justify-content:space-between;align-items:center;margin-bottom:8px;gap:8px;flex-wrap:wrap">
  <div style="font-weight:700">Aufgussplan <span class="mut">(<span id="activeDayLabel">‚Äî</span>)</span></div>
  <div id="gridActionsLeft" class="row" style="gap:6px">
    <button class="btn sm" id="btnUndo" title="R√ºckg√§ngig" disabled>‚Ü∂ R√ºckg√§ngig</button>
    <button class="btn sm" id="btnRedo" title="Wiederholen" disabled>‚Ü∑ Wiederholen</button>
  </div>
<div class="row" style="gap:8px;flex-wrap:wrap">
    <div id="weekdayPills" class="row" style="gap:6px"></div>
    <button class="btn sm" id="btnSavePreset" title="Wochentag speichern">üíæ Wochentag speichern</button>
    <span class="mut">Ausgew√§hlte Zeit:</span> <span id="selTime" style="font-weight:700">‚Äî</span>
  </div>
</div>
          <table id="grid" class="tbl"></table>
          <div class="row" style="margin:12px 0 4px">
            <button class="btn sm" id="btnAddAbove">Zeile dar√ºber +</button>
            <button class="btn sm" id="btnAddBelow">Zeile darunter +</button>
            <button class="btn sm" id="btnDeleteRow">Ausgew√§hlte Zeile l√∂schen</button>
            <span class="mut">Zeit anklicken = Zeile markieren ¬∑ Zeit√§nderungen im Dialog verschieben Aufguss korrekt.</span>
          </div>
        </div>
      </div>
    </section>

    <aside class="rightbar">
      <div class="layout-resizer" id="layoutResizer" role="separator" aria-orientation="vertical" aria-label="Sidebar-Gr√∂√üe anpassen" tabindex="0" aria-hidden="false"></div>
      <div class="rightbar-columns">
<!-- Slides ‚Äì Masterbox -->
<details class="ac full" open id="slidesMaster" data-jump-target>
  <summary>
    <div class="ttl">‚ñ∂<span class="chev">‚Æû</span> Slides ‚Äì Reihenfolge, Sichtbarkeit & Zeiten</div>
    <div class="actions">
      <button class="btn sm ghost" id="resetTiming">Standardwerte</button>
    </div>
  </summary>
  <div class="content">
    <div class="settings-stack">
      <div class="settings-card" id="slidesFlowCard" data-jump-target>
        <div class="settings-card-head">
          <div class="settings-card-title">Ablauf &amp; Zeitsteuerung</div>
          <p class="settings-card-description">Bestimme Dauer, √úberg√§nge und Verhalten beim Abspielen.</p>
        </div>
        <div class="settings-card-body">
          <!-- Dauer-Modus (global, gilt f√ºr Saunen + Bilder) -->
          <div class="kv" id="rowDurMode">
            <label>Dauer-Modus <span class="tip" title="Bestimmt, ob alle Slides dieselbe Dauer haben oder individuell gesteuert werden.">‚ùî</span></label>
            <div class="row">
              <label class="btn sm ghost" style="gap:6px"><input type="radio" name="durMode" id="durUniform" value="uniform"> Einheitlich</label>
              <label class="btn sm ghost" style="gap:6px"><input type="radio" name="durMode" id="durPer" value="per"> Individuell pro Slide</label>
            </div>
          </div>

          <div class="kv" id="rowDwellAll">
            <label>Dauer (einheitlich)</label>
            <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
              <span class="mut" style="min-width:14ch;">alle au√üer √úbersicht</span>
              <input id="dwellAll" class="input num3" type="number" min="1" max="120" step="1" />

              <span class="mut" style="min-width:10ch;">√úbersicht</span>
              <input id="ovSecGlobal" class="input num3" type="number" min="1" max="120" step="1" />
            </div>
          </div>

          <!-- Transition -->
          <div class="kv">
            <label>Transition (ms)</label>
            <input id="transMs2" class="input" type="number" min="0" value="500">
          </div>

          <div class="kv">
            <label>Weiter erst nach Video-Ende</label>
            <input id="waitForVideo" type="checkbox">
          </div>
        </div>
      </div>

      <div class="settings-card" id="slidesAutomationCard" data-jump-target>
        <div class="settings-card-head">
          <div class="settings-card-title">Automatisierung</div>
          <p class="settings-card-description">L√§dt zu Start oder Tab-Wechsel automatisch passende Voreinstellungen.</p>
        </div>
        <details class="settings-card-body style-auto-fold" id="styleAutomationFold" open>
          <summary class="style-auto-summary">
            <span class="style-auto-summary-text">Automatisierung konfigurieren</span>
            <span class="style-auto-summary-chev" aria-hidden="true">‚ñæ</span>
          </summary>
          <div class="style-auto-inner">
            <div class="kv">
              <label>Auto je Wochentag <span class="tip" title="L√§dt beim Start automatisch das Preset des aktuellen Wochentags.">‚ùî</span></label>
              <input id="presetAuto" type="checkbox">
            </div>
            <div class="help">Wenn aktiv, wird beim √ñffnen und beim Wechsel des Tabs automatisch das Preset des aktuellen Wochentags geladen (falls vorhanden).</div>
            <div class="divider"></div>
            <div class="kv">
              <label>Style-Automation aktiv</label>
              <input id="styleAutoEnabled" type="checkbox">
            </div>
            <div class="kv">
              <label>Fallback-Stil</label>
              <select id="styleAutoFallback" class="input"></select>
            </div>
            <div class="style-auto-list" id="styleAutoList"></div>
            <div class="row style-auto-actions">
              <button class="btn sm" id="styleAutoAdd">Zeitfenster hinzuf√ºgen</button>
            </div>
          </div>
        </details>
      </div>

    </div>

    <!-- Unterbox 1: Saunen & √úbersicht -->
    <details class="ac sub" open id="boxSaunas" data-jump-target>
      <summary><div class="ttl">‚ñ∂<span class="chev">‚Æû</span> Saunen & √úbersicht</div>
 <div class="actions"><button class="btn sm" id="btnAddSauna">Sauna hinzuf√ºgen</button></div>
</summary>      
<div class="content">

        <!-- √úbersicht im Saunen-Stil -->
        <div class="fieldset" style="margin-bottom:10px">
          <div class="legend">√úbersicht (Aufgussplan)</div>
          <div id="overviewRow"></div>
        </div>

        <!-- Saunenliste -->
		<!-- Kopf f√ºr den Bereich "Aufguss" + 2. Wochentags-Pillen -->
<div class="groupHead">
  <div class="legend">Aufguss</div>
  <div id="weekdayPills2" class="day-pills row" style="gap:6px"></div>
</div>
 	<!-- Aufguss -->
<div class="sl-head sl-saunas">
  <span class="col-name">Name</span>
  <span class="col-prev">Preview</span>
  <span class="col-dur" id="headSaunaDur">Dauer (s)*</span>
  <span class="col-up">Upload</span>
  <span class="col-def">Default</span>
  <span class="col-del">‚úï</span>
  <span class="col-vis">Anzeigen</span>
</div>
        
	<!-- kein Aufguss -->
	<div id="saunaList"></div>
	<div class="subh" id="extraTitle" style="display:none">Heute kein Aufguss</div>
        <div id="extraSaunaList"></div>

        <div class="help" style="margin-top:6px">* Dauer nur sichtbar, wenn ‚ÄûIndividuell‚Äú gew√§hlt ist.</div>
      </div>
    </details>

    <!-- Unterbox 2: Fu√ünoten & Badges -->
    <details class="ac sub" id="boxFootnotes" data-jump-target>
  <summary>
    <div class="ttl">‚ñ∂<span class="chev">‚Æû</span> Fu√ünoten &amp; Badges</div>
    <div class="actions"><button class="btn sm" id="fnAdd">Fu√ünote hinzuf√ºgen</button></div>
  </summary>
  <div class="content">
    <div class="footnote-section" id="footnoteSection" data-jump-target>
      <div class="footnote-header">
        <button class="footnote-toggle" type="button" id="footnoteToggle" aria-expanded="false" aria-controls="footnoteBody">Fu√ünoten verwalten</button>
      </div>
      <div class="footnote-body" id="footnoteBody" aria-hidden="true">
        <div class="footnote-body-inner">
          <div id="fnList"></div>
        </div>
      </div>
    </div>
    <div class="subh">Darstellung</div>
    <div class="kv">
      <label>Fu√ünoten-Layout <span class="tip" title="Legt fest, wie mehrere Fu√ünoten dargestellt werden.">‚ùî</span></label>
      <select id="footnoteLayout" class="input">
        <option value="one-line" selected>M√∂glichst einzeilig</option>
        <option value="multi">Mehrzeilig</option>
        <option value="stacked">Untereinander (jede Zeile)</option>
      </select>
    </div>
    <div class="badge-lib-section" id="badgeLibrarySection" data-jump-target>
      <div class="badge-lib-header">
        <button class="badge-lib-toggle" type="button" id="badgeLibraryToggle" aria-expanded="false" aria-controls="badgeLibraryBody">Badge-Bibliothek</button>
        <button class="btn sm" id="badgeAdd" type="button">Badge hinzuf√ºgen</button>
      </div>
      <div class="badge-lib-body" id="badgeLibraryBody" aria-hidden="true">
        <div class="badge-lib-body-inner">
          <div class="badge-lib-tools" id="badgeEmojiTools">
            <div class="badge-lib-tools-head">
              <div class="badge-lib-tools-title">Emoji-Auswahl</div>
              <div class="badge-lib-tools-text">W√§hle ein Emoji aus der Liste oder erg√§nze eigene Favoriten f√ºr die Badges.</div>
            </div>
            <div class="badge-lib-tools-body">
              <div class="badge-lib-emoji-add">
                <input id="badgeEmojiInput" class="input" type="text" maxlength="8" placeholder="Emoji einf√ºgen" aria-label="Eigenes Emoji">
                <button class="btn sm" id="badgeEmojiAdd" type="button" disabled>Emoji hinzuf√ºgen</button>
              </div>
              <div class="badge-lib-emoji-list" id="badgeEmojiCustom" aria-live="polite"></div>
            </div>
          </div>
          <div id="badgeLibraryList" class="badge-library-list"></div>
          <div class="help">Verwalte Emoji, Bild und Label der ausw√§hlbaren Badges f√ºr Aufg√ºsse.</div>
        </div>
      </div>
    </div>
  </div>
</details>

    <!-- Unterbox 4: Globale Zusatzinhalte & Informationen -->
    <details class="ac sub" id="boxStories" data-jump-target>
      <summary>
        <div class="ttl">‚ñ∂<span class="chev">‚Æû</span> Global Zusatzinhalte &amp; Informationen</div>
      </summary>
      <div class="content global-info-pane">
        <div class="global-info-sections">
          <details class="info-fold" id="infoWellness" open data-jump-target>
            <summary>Wellness-Tipps</summary>
            <div class="info-fold-body">
              <div class="extras-group" id="extrasWellness">
                <div class="extras-group-head">
                  <div class="extras-group-title">Wellness-Tipps</div>
                  <button class="btn sm" id="extrasWellnessAdd">Tipp hinzuf√ºgen</button>
                </div>
                <div class="extras-group-list" id="extrasWellnessList"></div>
              </div>
            </div>
          </details>
          <details class="info-fold" id="infoEvents" open data-jump-target>
            <summary>Event-Countdowns</summary>
            <div class="info-fold-body">
              <div class="extras-group" id="extrasEvents">
                <div class="extras-group-head">
                  <div class="extras-group-title">Event-Countdowns</div>
                  <button class="btn sm" id="extrasEventAdd">Event hinzuf√ºgen</button>
                </div>
                <div class="extras-group-list" id="extrasEventList"></div>
                <div class="help">Datums- und Zeitangabe im lokalen Format, z.&nbsp;B. 2024-12-24T20:00.</div>
              </div>
            </div>
          </details>
          <details class="info-fold" id="infoGastro" open data-jump-target>
            <summary>Gastro-Infos</summary>
            <div class="info-fold-body">
              <div class="extras-group" id="extrasGastro">
                <div class="extras-group-head">
                  <div class="extras-group-title">Gastronomie-Highlights</div>
                  <button class="btn sm" id="extrasGastroAdd">Highlight hinzuf√ºgen</button>
                </div>
                <div class="extras-group-list" id="extrasGastroList"></div>
              </div>
            </div>
          </details>
          <details class="info-fold" id="infoHero" data-jump-target>
            <summary>Hero-Timeline</summary>
            <div class="info-fold-body hero-fold-body">
              <div class="kv">
                <label class="row" style="gap:8px;align-items:center">
                  <input id="heroTimelineEnabled" type="checkbox">
                  <span>Hero-Timeline anzeigen</span>
                </label>
              </div>
              <div class="kv" id="heroTimelineSettings" hidden>
                <label>Einstellungen</label>
                <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
                  <span class="mut">Dauer (s)</span>
                  <input id="heroTimelineDuration" class="input num3" type="number" min="1" max="120" step="1">
                  <span class="mut">Basis-Minuten</span>
                  <input id="heroTimelineBase" class="input num3" type="number" min="1" max="120" step="1">
                  <span class="mut">Max. Eintr√§ge</span>
                  <input id="heroTimelineMax" class="input num3" type="number" min="1" max="50" step="1" placeholder="leer = alle">
                </div>
              </div>
            </div>
          </details>
          <details class="info-fold" id="infoStories" data-jump-target>
            <summary>Story-Slides</summary>
            <div class="info-fold-body story-fold-body">
              <div class="info-fold-actions"><button class="btn sm" id="btnStoryAdd">Information hinzuf√ºgen</button></div>
              <div class="story-builder-pane">
                <div class="subh">Informationen</div>
                <div class="help">Pflege Texte, Bilder und Layout f√ºr erkl√§rende Slides in einem flexiblen Spalten-Baukasten.</div>
                <div class="story-builder" id="storyBuilder">
                  <div class="story-builder-list" id="storyList"></div>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>
    </details>

    <!-- Unterbox 4: Medien-Slides -->
    <details class="ac sub" id="boxImages" data-jump-target>
<summary>
    <div class="ttl">‚ñ∂<span class="chev">‚Æû</span> Medien-Slides</div>
    <div class="actions"><button class="btn sm" id="btnMediaAdd">Medien hinzuf√ºgen</button></div>
  </summary>
<small class="help">* Dauer nur sichtbar, wenn ‚ÄûIndividuell pro Slide‚Äú gew√§hlt ist.</small>
  <div class="content">
<div class="sl-head sl-images">
    <span class="col-name">Name</span>
    <span class="col-type">Typ</span>
    <span class="col-prev">Preview</span>
    <span class="col-dur" id="headImgDur">Dauer (s)</span>
    <span class="col-up">Upload</span>
    <span class="col-del">‚úï</span>
    <span class="col-vis">Anzeigen</span>
  </div>
    <div id="interList2"></div>
  </div>
</details>

  </div>
</details>

 <details class="ac full" id="boxSlidesText" data-jump-target>
        <summary>
          <div class="ttl">‚ñ∂<span class="chev">‚Æû</span> Slideshow & Text</div>
          <div class="actions"><button class="btn sm ghost" id="resetSlides">Standardwerte</button></div>
        </summary>
        <div class="content">
          <div class="layout-display-block">
            <details class="layout-display-fold" id="displayLayoutFold" open data-jump-target>
              <summary class="layout-display-summary">
                <span class="layout-display-summary-text">
                  <span class="layout-display-summary-title">Darstellung &amp; Seiten</span>
                  <span class="layout-display-summary-sub">Einspaltig oder Zweispaltig konfigurieren</span>
                </span>
                <span class="layout-display-chev" aria-hidden="true">‚ñæ</span>
              </summary>
              <div class="layout-display-body">
                <div class="kv">
                  <label>Darstellung</label>
                  <select id="layoutMode" class="input">
                    <option value="single">Einspaltig</option>
                    <option value="split">Zweispaltig</option>
                  </select>
                </div>
                <div class="kv">
                  <label>Layout-Profil</label>
                  <select id="layoutProfile" class="input">
                    <option value="landscape">Standard (16:9)</option>
                    <option value="portrait">Portrait ‚Äì Einzel</option>
                    <option value="portrait-split">Portrait ‚Äì geteilte Bereiche</option>
                    <option value="triple">Triple-Column</option>
                    <option value="asymmetric">Asymmetrisch</option>
                  </select>
                </div>
                <div class="layout-display-columns">
                  <div class="fieldset layout-page" id="layoutLeft">
                    <div class="legend">Linke Seite</div>
                    <div class="kv">
                      <label>Timer (Sekunden)</label>
                      <input id="pageLeftTimer" class="input num3" type="number" min="0" max="600" step="1" placeholder="0 = global">
                    </div>
                    <div class="kv">
                      <label>Playlist</label>
                      <div class="playlist-selector" id="pageLeftPlaylist"></div>
                      <div class="help">Klicken zum (De-)Aktivieren, Pfeile oder Ziehen f√ºr die Reihenfolge. Eine leere Playlist nutzt den Standardfilter.</div>
                    </div>
                  </div>
                  <div class="fieldset layout-page" id="layoutRight">
                    <div class="legend">Rechte Seite</div>
                    <div class="kv">
                      <label>Timer (Sekunden)</label>
                      <input id="pageRightTimer" class="input num3" type="number" min="0" max="600" step="1" placeholder="0 = global">
                    </div>
                    <div class="kv">
                      <label>Playlist</label>
                      <div class="playlist-selector" id="pageRightPlaylist"></div>
                      <div class="help">Klicken zum (De-)Aktivieren, Pfeile oder Ziehen f√ºr die Reihenfolge.</div>
                    </div>
                    <div class="help">Wird verwendet, wenn das Zweispalten-Layout aktiv ist.</div>
                  </div>
                </div>
              </div>
            </details>
          </div>
          <div class="settings-grid two-col">
            <div class="settings-card">
              <div class="settings-card-head">
                <div class="settings-card-title">Style Paletten</div>
              </div>
              <div class="settings-card-body">
                <div class="kv">
                  <label>Stil-Paletten</label>
                  <div class="style-set-controls" id="styleSetControls" data-jump-target>
                    <select id="styleSetSelect" class="input"></select>
                    <div class="row" style="gap:6px;flex-wrap:wrap">
                      <button class="btn sm" id="styleSetApply" type="button">Aktivieren</button>
                      <button class="btn sm ghost" id="styleSetSave" type="button">Aktualisieren</button>
                      <button class="btn sm ghost" id="styleSetCreate" type="button">Neu</button>
                      <button class="btn sm ghost" id="styleSetDelete" type="button">L√∂schen</button>
                    </div>
                  </div>
                </div>
                <div class="kv"><label>Palettenname</label><input id="styleSetLabel" class="input" type="text" placeholder="Palette"></div>
                <div class="help">Paletten speichern Farben, Typografie und Badge-Optionen. ‚ÄûAktivieren‚Äú √ºbernimmt die Auswahl in die aktuellen Einstellungen.</div>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-head">
                <div class="settings-card-title">Typografie ‚Äì Basis</div>
              </div>
              <div class="settings-card-body">
                <div class="kv"><label>Schriftfamilie</label>
                  <select id="fontFamily" class="input">
                    <option value="system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, Ubuntu, Cantarell, 'Helvetica Neue',sans-serif">System (Default)</option>
                    <option value="Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif">Montserrat</option>
                    <option value="Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif">Roboto</option>
                    <option value="'Open Sans', system-ui, -apple-system, Segoe UI, Arial, sans-serif">Open Sans</option>
                    <option value="Lato, system-ui, -apple-system, Segoe UI, Arial, sans-serif">Lato</option>
                  </select>
                </div>
                <div class="kv"><label>Globaler Scale</label><input id="fontScale" class="input" type="number" step="0.05" min="0.5" max="3" value="1"></div>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-head">
                <div class="settings-card-title">Typografie ‚Äì √úberschriften</div>
              </div>
              <div class="settings-card-body">
                <div class="kv"><label>H1 Scale</label><input id="h1Scale" class="input" type="number" step="0.05" min="0.5" max="3.5" value="1"></div>
                <div class="kv"><label>H2 Scale</label><input id="h2Scale" class="input" type="number" step="0.05" min="0.5" max="3.5" value="1"></div>
                <div class="kv"><label>H2 Modus</label>
                  <select id="h2Mode" class="input">
                    <option value="none">‚Äî nichts ‚Äî</option>
                    <option value="text" selected>Nur Text</option>
                    <option value="weekday">Wochentag</option>
                    <option value="date">Datum</option>
                    <option value="text+weekday">Text + Wochentag</option>
                    <option value="text+date">Text + Datum</option>
                  </select>
                </div>
                <div class="kv"><label>H2 Text</label><input id="h2Text" class="input" type="text" placeholder="Aufgusszeiten"></div>
                <div class="kv"><label>H2 in √úbersicht anzeigen</label><input id="h2ShowOverview" type="checkbox" checked></div>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-head">
                <div class="settings-card-title">√úbersicht (Tabelle)</div>
              </div>
              <div class="settings-card-body">
                <div class="kv"><label>√úbersichtstitel Scale</label><input id="ovTitleScale" class="input" type="number" step="0.05" min="0.4" max="4" value="1"></div>
                <div class="kv"><label>Kopf‚ÄëScale</label><input id="ovHeadScale" class="input" type="number" step="0.05" min="0.5" max="3" value="0.9"></div>
                <div class="kv"><label>Zellen‚ÄëScale</label><input id="ovCellScale" class="input" type="number" step="0.05" min="0.5" max="3" value="0.8"></div>
                <div class="kv"><label>Zeitspaltenbreite (ch)</label><input id="ovTimeWidth" class="input" type="number" step="0.5" min="6" max="24" value="10"></div>
                <div class="kv"><label>Chip‚ÄëH√∂he (%)</label><input id="chipH" class="input" type="number" min="50" max="200" value="100"></div>
                <div class="help">Chips sind immer gleich breit/hoch (f√ºllen die Zelle) und zentriert.</div>
                <div class="kv"><label>Text√ºberl√§nge</label>
                  <select id="chipOverflowMode" class="input">
                    <option value="scale" selected>Automatisch skalieren</option>
                    <option value="ellipsis">Mit ‚Äû‚Ä¶‚Äú k√ºrzen</option>
                  </select>
                </div>
                <div class="kv"><label>Flammen anzeigen</label><input id="overviewFlames" type="checkbox" checked></div>
                <div class="kv"><label>Flammen-Gr√∂√üe (% der Chip-H√∂he)</label>
                  <input id="flamePct" class="input" type="number" min="30" max="100" value="55">
                </div>
                <div class="kv"><label>Flammen-Abstand (Faktor)</label>
                  <input id="flameGap" class="input" type="number" min="0" max="1" step="0.01" value="0.14">
                </div>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-head">
                <div class="settings-card-title">Saunafolien &amp; Komponenten</div>
              </div>
              <div class="settings-card-body">
                <div class="kv"><label>Text‚ÄëScale</label><input id="tileTextScale" class="input" type="number" step="0.05" min="0.5" max="3" value="0.8"></div>
                <div class="kv"><label>Font‚ÄëWeight</label>
                  <select id="tileWeight" class="input">
                    <option value="400">Normal (400)</option>
                    <option value="500">Medium (500)</option>
                    <option value="600" selected>Semibold (600)</option>
                    <option value="700">Bold (700)</option>
                    <option value="800">Extra Bold (800)</option>
                  </select>
                </div>
                <div class="kv"><label>Uhrzeit Scale</label><input id="tileTimeScale" class="input" type="number" step="0.05" min="0.5" max="2" value="1"></div>
                <div class="kv"><label>‚ÄûUhr‚Äú hinter Uhrzeiten anzeigen</label><input id="timeSuffixToggle" type="checkbox"></div>
                <div class="kv"><label>Flammen in Kacheln anzeigen</label><input id="saunaFlames" type="checkbox" checked></div>
                <div class="kv"><label>Flammen-Gr√∂√üe (Faktor)</label><input id="tileFlameSizeScale" class="input" type="number" step="0.05" min="0.4" max="3" value="1"></div>
                <div class="kv"><label>Flammen-Abstand (Faktor)</label><input id="tileFlameGapScale" class="input" type="number" step="0.05" min="0" max="3" value="1"></div>
                <div class="kv"><label>Badge-Scale (Faktor)</label><input id="badgeScale" class="input" type="number" step="0.05" min="0.3" max="3" value="1"></div>
                <div class="kv"><label>Beschreibung-Scale (Faktor)</label><input id="badgeDescriptionScale" class="input" type="number" step="0.05" min="0.3" max="3" value="1"></div>
                <div class="kv"><label>Badges neben Aufguss anzeigen</label><input id="badgeInlineColumn" type="checkbox"></div>
                <div class="kv"><label>Kachel‚ÄëBreite % (sichtbarer Bereich)</label><input id="tilePct" class="input" type="number" min="1" max="100" value="45"></div>
                <div class="kv"><label>Kachel‚ÄëBreite min (Faktor)</label><input id="tileMin" class="input" type="number" min="0" max="1" step="0.01" value="0.25"></div>
                <div class="kv"><label>Kachel‚ÄëBreite max (Faktor)</label><input id="tileMax" class="input" type="number" min="0" max="1" step="0.01" value="0.57"></div>
                <div class="kv"><label>H1 Max-Breite (%)</label><input id="saunaHeadingWidth" class="input" type="number" min="10" max="100" value="100"></div>
                <div class="kv"><label>Kachel-H√∂hen-Scale</label><input id="tileHeightScale" class="input" type="number" step="0.05" min="0.5" max="2" value="1"></div>
                <div class="kv"><label>Innenabstand (Faktor)</label><input id="tilePaddingScale" class="input" type="number" step="0.05" min="0.25" max="1.5" value="0.75"></div>
                <div class="kv"><label>Badge-Farbe</label>
                  <input id="badgeColor" class="input" type="color" value="#5C3101" title="Badge-Farbe">
                </div>
                <div class="kv"><label>Farbverlauf anzeigen</label><input id="tileOverlayEnabled" type="checkbox" checked></div>
                <div class="kv"><label>Farbverlauf-St√§rke (%)</label><input id="tileOverlayStrength" class="input" type="number" step="5" min="0" max="200" value="100"></div>
                <div class="kv">
                  <label>Komponenten auf Slides</label>
                  <div id="componentToggleWrap" class="component-toggle-wrap">
                    <label class="btn sm ghost component-toggle"><input type="checkbox" data-component="title"> Titel &amp; Uhrzeit</label>
                    <label class="btn sm ghost component-toggle"><input type="checkbox" data-component="description"> Beschreibung</label>
                    <label class="btn sm ghost component-toggle"><input type="checkbox" data-component="badges"> Badge-Leiste</label>
                  </div>
                  <div class="help">Gilt auch f√ºr die Verf√ºgbarkeitsliste in Story-Slides.</div>
                </div>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-head">
                <div class="settings-card-title">Bildspalte &amp; Layout</div>
              </div>
              <div class="settings-card-body">
                <div class="kv"><label>Breite rechts (%)</label><input id="rightW" class="input" type="number" min="0" max="70" value="38"></div>
                <div class="kv"><label>Schnitt oben (%)</label><input id="cutTop" class="input" type="number" min="0" max="100" value="28"></div>
                <div class="kv"><label>Schnitt unten (%)</label><input id="cutBottom" class="input" type="number" min="0" max="100" value="12"></div>
                <div class="help">Bestimmt Breite der Bildspalte und die beiden Ankerpunkte (oben/unten) der diagonalen Schnittkante.</div>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-head">
                <div class="settings-card-title">Flammen / Hervorhebungen</div>
              </div>
              <div class="settings-card-body">
                <div class="kv"><label>Highlight aktiv</label><input id="hlEnabled" type="checkbox"></div>
                <div class="kv"><label>Highlight‚ÄëFarbe (Hex)</label><div class="color-item"><div id="hlSw" class="swatch"></div><input id="hlColor" class="input" type="text" value="#FFDD66" placeholder="#RRGGBB"></div></div>
                <div class="kv"><label>Min. vor Start</label><input id="hlBefore" class="input" type="number" min="0" max="120" value="15"></div>
                <div class="kv"><label>Min. nach Start</label><input id="hlAfter" class="input" type="number" min="0" max="120" value="15"></div>
                <div class="kv"><label>Flammen‚ÄëBild</label>
                  <div class="row" style="gap:8px">
                    <img id="flamePrev" class="prev" alt="">
                    <input id="flameImg" type="hidden" />
                    <label class="btn sm ghost" style="position:relative;overflow:hidden"><input id="flameFile" type="file" accept="image/*" style="position:absolute;inset:0;opacity:0">Upload</label>
                    <button class="btn sm" id="resetFlame">Default</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
</details>

      <details class="ac full">
        <summary>
          <div class="ttl">‚ñ∂<span class="chev">‚Æû</span> Farben (√úbersicht & Zeitspalte)</div>
          <div class="actions"><button class="btn sm ghost" id="resetColors">Standardwerte</button></div>
        </summary>
        <div class="content color-cols" id="colorList"></div>
      </details>

      <details class="ac">
        <summary>
          <div class="ttl">‚ñ∂<span class="chev">‚Æû</span> System</div>
        </summary>
        <div class="content">
          <div class="sys-grid">
            <div class="sys-action">
              <button class="btn icon-label" id="btnExport">
                <span class="icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" focusable="false">
                    <path d="M12 3a1 1 0 0 1 .82.42l4 5.5A1 1 0 0 1 16 10h-3v6a1 1 0 1 1-2 0v-6H8a1 1 0 0 1-.82-1.58l4-5.5A1 1 0 0 1 12 3zm8 16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2h16z" fill="currentColor"/>
                  </svg>
                </span>
                <span>Export</span>
              </button>
            </div>
            <div class="sys-options">
              <label class="btn sm ghost sys-toggle">
                <input type="checkbox" id="expWithSettings" checked>
                <span>Einst.</span>
              </label>
              <label class="btn sm ghost sys-toggle">
                <input type="checkbox" id="expWithSchedule" checked>
                <span>Zeiten</span>
              </label>
              <label class="btn sm ghost sys-toggle">
                <input type="checkbox" id="expWithImg">
                <span>Bilder</span>
              </label>
            </div>
            <div class="sys-action">
              <label class="btn icon-label sys-file-btn">
                <span class="icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" focusable="false">
                    <path d="M12 21a1 1 0 0 1-.82-.42l-4-5.5A1 1 0 0 1 8 14h3V8a1 1 0 0 1 2 0v6h3a1 1 0 0 1 .82 1.58l-4 5.5A1 1 0 0 1 12 21zM4 5a1 1 0 0 1 0-2h16a1 1 0 0 1 0 2H4z" fill="currentColor"/>
                  </svg>
                </span>
                <span>Import</span>
                <input id="importFile" type="file" accept="application/json">
              </label>
            </div>
            <div class="sys-options">
              <label class="btn sm ghost sys-toggle">
                <input type="checkbox" id="impWriteSettings" checked>
                <span>Einst.</span>
              </label>
              <label class="btn sm ghost sys-toggle">
                <input type="checkbox" id="impWriteSchedule" checked>
                <span>Zeiten</span>
              </label>
              <label class="btn sm ghost sys-toggle">
                <input type="checkbox" id="impWriteImg" checked>
                <span>Bilder</span>
              </label>
            </div>
          </div>
          <div class="sys-cleanup">
            <button class="btn sm ghost" id="btnCleanupSys">Assets aufr√§umen</button>
          </div>
          <small class="help">Export/Import von Einstellungen & Plan. ‚ÄûBilder einschlie√üen‚Äú packt Flamme & Saunen-Bilder mit ein.</small>
        </div>
      </details>

      </div>

    </aside>
  </main>

  <footer>¬© Andrej Soennecken</footer>

  <!-- Dialog Zelle -->
  <div id="modal" class="modal">
    <div class="box">
      <div class="grid2">
        <label>Uhrzeit</label><input id="m_time" class="input" type="text" placeholder="HH:MM">
        <label>Titel</label><input id="m_title" class="input" type="text" placeholder="z.B. Vulkan">
        <label>Flammen</label>
        <select id="m_flames" class="input">
          <option value="">‚Äî</option>
          <option>1</option><option>2</option><option>3</option>
        </select>
        <label>Fu√ünote</label>
        <div>
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="m_hasNote"> hinzuf√ºgen</label>
          <div class="row" id="m_noteRow" style="margin-top:8px;display:none">
            <select id="m_note" class="input"></select>
          </div>
        </div>
        <label>Beschreibung</label>
        <textarea id="m_description" class="input" rows="3" placeholder="Kurze Beschreibung oder Ritual"></textarea>
        <label>Badges</label>
        <div id="m_badgeList" class="badge-picker"></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:14px">
        <button class="btn" id="m_cancel">Abbrechen</button>
        <button class="btn primary" id="m_ok">OK</button>
      </div>
    </div>
  </div>

<!-- Ger√§te-Vorschau (ohne Pairing) ‚Äì ACHTUNG: SIBLING, NICHT im prevModal! -->
<div id="devPrevModal" class="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div style="font-weight:700" data-devprev-title>Ger√§te-Ansicht</div>
      <div class="row">
        <button class="btn sm" id="devPrevReload">Neu laden</button>
        <button class="btn sm" id="devPrevClose">Schlie√üen</button>
      </div>
    </div>
    <div class="iframeWrap">
      <iframe id="devPrevFrame" src="about:blank" loading="lazy" referrerpolicy="no-referrer"></iframe>
    </div>
    <small class="mut" style="display:block;margin-top:8px">
      Live-Ansicht des ausgew√§hlten Ger√§ts (nur Lesen; kein Pairing, keine Speicherung).
    </small>
  </div>
</div>

<div id="helpOverlay" hidden>
  <div class="panel">
    <button id="helpClose" class="btn icon" aria-label="Schlie√üen">‚úï</button>
    <h2>Schnellstart</h2>
    <ul>
      <li>Nutze ‚ÄûSauna hinzuf√ºgen‚Äú, um neue Slides zu erstellen.</li>
      <li>Wechsle zur Ansicht ‚ÄûGer√§te‚Äú, um Displays zu bearbeiten.</li>
    </ul>
    <p>Mehr Hilfe in der <a href="/admin/help.md" target="_blank">Dokumentation</a>.</p>
  </div>
</div>

<script>
  (function(){
    const cockpit = document.querySelector('.workspace-overview');
    if (!cockpit) return;
    const body = cockpit.querySelector('.workspace-body');
    if (!body) return;

    const root = document.documentElement;
    const header = document.querySelector('header');
    const toolbar = cockpit.querySelector('.workspace-toolbar');

    const resolveCockpitHeight = () => {
      if (cockpit.dataset.pinned !== 'true') return 0;
      if (cockpit.dataset.collapsed === 'true') {
        return toolbar?.offsetHeight || cockpit.offsetHeight;
      }
      return cockpit.offsetHeight;
    };

    const updateOffsets = () => {
      const headerHeight = header?.offsetHeight || 0;
      const pinned = cockpit.dataset.pinned === 'true';
      const cockpitHeight = pinned ? resolveCockpitHeight() : 0;
      const workspaceOffset = Math.max(132, headerHeight + cockpitHeight + (pinned ? 28 : 24));
      const stickTop = headerHeight + 12;
      const devicesOffset = headerHeight + cockpitHeight + 12;

      root?.style.setProperty('--workspace-offset', `${workspaceOffset}px`);
      root?.style.setProperty('--cockpit-stick-top', `${stickTop}px`);
      root?.style.setProperty('--devices-offset', `${devicesOffset}px`);
      root?.style.setProperty('scroll-padding-top', `${workspaceOffset}px`);
      document.body?.style.setProperty('scroll-padding-top', `${workspaceOffset}px`);
    };

    const scheduleUpdate = () => {
      if ('requestAnimationFrame' in window) {
        window.requestAnimationFrame(updateOffsets);
      } else {
        updateOffsets();
      }
    };

    if ('ResizeObserver' in window){
      const resizeObserver = new ResizeObserver(() => scheduleUpdate());
      resizeObserver.observe(cockpit);
      if (header) resizeObserver.observe(header);
      window.addEventListener('beforeunload', () => resizeObserver.disconnect(), { once:true });
    }

    if ('MutationObserver' in window){
      const bodyObserver = new MutationObserver(() => scheduleUpdate());
      bodyObserver.observe(document.body, { attributes:true, attributeFilter:['class'] });
      window.addEventListener('beforeunload', () => bodyObserver.disconnect(), { once:true });
    }

    window.addEventListener('resize', scheduleUpdate, { passive:true });

    const pinBtn = cockpit.querySelector('[data-action="pin"]');
    const toggleBtn = cockpit.querySelector('[data-action="toggle"]');

    let storageAvailable = true;
    try{
      const testKey = '__cockpit__';
      localStorage.setItem(testKey, '1');
      localStorage.removeItem(testKey);
    }catch(err){
      storageAvailable = false;
    }

    const load = (key) => storageAvailable ? localStorage.getItem(key) : null;
    const save = (key, value) => {
      if (!storageAvailable) return;
      if (value === null){
        localStorage.removeItem(key);
      }else{
        localStorage.setItem(key, value);
      }
    };

    const PIN_KEY = 'adminCockpitPinned';
    const COLLAPSE_KEY = 'adminCockpitCollapsed';

    const setPinState = (pinned) => {
      cockpit.dataset.pinned = pinned ? 'true' : 'false';
      if (pinBtn){
        pinBtn.setAttribute('aria-pressed', String(pinned));
        pinBtn.classList.toggle('is-active', pinned);
        const label = pinBtn.querySelector('[data-role="label"]');
        const icon = pinBtn.querySelector('[data-role="icon"]');
        if (label){
          const onText = label.dataset.labelPinned || label.textContent;
          const offText = label.dataset.labelUnpinned || label.textContent;
          label.textContent = pinned ? onText : offText;
        }
        if (icon){
          const onIcon = icon.dataset.iconPinned || icon.textContent;
          const offIcon = icon.dataset.iconUnpinned || icon.textContent;
          icon.textContent = pinned ? onIcon : offIcon;
        }
        pinBtn.setAttribute('title', pinned ? 'Cockpit l√∂sen' : 'Cockpit anheften');
      }
      save(PIN_KEY, pinned ? '1' : null);
      scheduleUpdate();
    };

    const setCollapseState = (collapsed) => {
      cockpit.dataset.collapsed = collapsed ? 'true' : 'false';
      body.hidden = collapsed;
      if (toggleBtn){
        toggleBtn.setAttribute('aria-expanded', String(!collapsed));
        toggleBtn.classList.toggle('is-active', !collapsed);
        const label = toggleBtn.querySelector('[data-role="label"]');
        const icon = toggleBtn.querySelector('[data-role="icon"]');
        if (label){
          const expandedText = label.dataset.labelExpanded || label.textContent;
          const collapsedText = label.dataset.labelCollapsed || label.textContent;
          label.textContent = collapsed ? collapsedText : expandedText;
        }
        if (icon){
          const expandedIcon = icon.dataset.iconExpanded || icon.textContent;
          const collapsedIcon = icon.dataset.iconCollapsed || icon.textContent;
          icon.textContent = collapsed ? collapsedIcon : expandedIcon;
        }
        toggleBtn.setAttribute('title', collapsed ? 'Cockpit √∂ffnen' : 'Cockpit minimieren');
      }
      save(COLLAPSE_KEY, collapsed ? '1' : null);
      scheduleUpdate();
    };

    let pinned = load(PIN_KEY) === '1';
    let collapsed = load(COLLAPSE_KEY) === '1';

    setPinState(pinned);
    setCollapseState(collapsed);
    scheduleUpdate();

    pinBtn?.addEventListener('click', () => {
      pinned = !pinned;
      setPinState(pinned);
    });

    toggleBtn?.addEventListener('click', () => {
      collapsed = !collapsed;
      setCollapseState(collapsed);
    });
  })();
</script>
<script>
  (function(){
    const actionButtons = document.querySelectorAll('.workspace-card [data-jump], .workspace-card [data-view], .workspace-card [data-devices]');
    if (!actionButtons.length) return;

    const ensureDetailsOpen = (element) => {
      if (!element) return;
      if (element.matches('details')) {
        element.open = true;
      }
      let parent = element.closest('details');
      while (parent) {
        parent.open = true;
        parent = parent.parentElement?.closest('details');
      }
    };

    const getScrollTarget = (element) => {
      if (!element) return null;
      if (element.hasAttribute('data-jump-target')) {
        return element;
      }
      return element.closest('[data-jump-target]') || element;
    };

    const highlight = (element) => {
      if (!element) return;
      element.classList.remove('jump-flash');
      void element.offsetWidth;
      element.classList.add('jump-flash');
      window.setTimeout(() => element.classList.remove('jump-flash'), 1600);
    };

    const canFocus = (element) => {
      if (!(element instanceof HTMLElement)) return false;
      if (element.tabIndex >= 0) return true;
      return /^(A|BUTTON|SUMMARY|INPUT|SELECT|TEXTAREA)$/i.test(element.tagName);
    };

    const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    const resolveTarget = (id) => {
      if (!id) return null;
      if (id.startsWith('#')) return document.querySelector(id);
      return document.getElementById(id);
    };

    const waitForElement = async (id, attempts = 4) => {
      if (!id) return null;
      const existing = resolveTarget(id);
      if (existing) return existing;
      if (attempts <= 0) return null;
      await sleep(120);
      return waitForElement(id, attempts - 1);
    };

    actionButtons.forEach((button) => {
      button.addEventListener('click', async (event) => {
        event.preventDefault();

        const desiredView = button.dataset.view;
        if (desiredView && typeof showView === 'function') {
          try {
            await showView(desiredView);
          } catch (error) {
            console.error('[admin] Ansicht konnte nicht gewechselt werden', error);
          }
        }

        const devicesAction = button.dataset.devices;
        if (devicesAction) {
          const devicesBtn = document.getElementById('btnDevices');
          const isActive = devicesBtn?.classList.contains('active');
          if (devicesBtn) {
            if ((devicesAction === 'open' || devicesAction === 'refresh') && !isActive) {
              devicesBtn.click();
            } else if (devicesAction === 'close' && isActive) {
              devicesBtn.click();
            } else if (devicesAction === 'toggle') {
              devicesBtn.click();
            }
          }
          if (devicesAction === 'refresh') {
            const attemptRefresh = async (tries = 4) => {
              if (typeof window.__refreshDevicesPane === 'function') {
                return window.__refreshDevicesPane({ bypassCache: true });
              }
              if (tries <= 0) return null;
              await sleep(120);
              return attemptRefresh(tries - 1);
            };
            try {
              await attemptRefresh();
            } catch (error) {
              console.error('[admin] Ger√§tebereich konnte nicht aktualisiert werden', error);
            }
          }
        }

        const targetId = button.dataset.jump;
        const highlightId = button.dataset.highlight;
        const target = await waitForElement(targetId) || await waitForElement(highlightId);
        if (!target) return;

        ensureDetailsOpen(target);

        const scrollTarget = getScrollTarget(target);
        window.requestAnimationFrame(() => {
          scrollTarget?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          const highlightEl = target.matches('details')
            ? target.querySelector(':scope > summary') || scrollTarget
            : scrollTarget;
          highlight(highlightEl);
          if (highlightEl && typeof highlightEl.focus === 'function' && canFocus(highlightEl)) {
            highlightEl.focus({ preventScroll: true });
          }
        });
      });
    });
  })();
</script>
<script>

  (function(){
    const p = '__PUBLIC_PORT__';
    const proto = location.protocol;
    const def = proto === 'https:' ? '443' : '80';
    let port = /^\d+$/.test(p) ? p : def;
    const suffix = port === def ? '' : ':' + port;
    window.SLIDESHOW_ORIGIN = `${proto}//${location.hostname}${suffix}`;
  })();

</script>
<script type="module" src="/admin/js/help.js"></script>
<script type="module" src="/admin/js/app.js"></script>
</body>
</html>

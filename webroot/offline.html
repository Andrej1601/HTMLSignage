<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Offline</title>
<style>
  body{margin:0;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#10131a;color:#f5f7fb;display:flex;align-items:center;justify-content:center;min-height:100vh;}
  .offline-wrap{max-width:720px;padding:48px 56px;background:rgba(15,19,28,.92);border-radius:24px;box-shadow:0 28px 60px rgba(0,0,0,.35);text-align:left;}
  h1{margin:0 0 12px;font-size:2.4rem;font-weight:800;letter-spacing:.01em;}
  p{margin:.5rem 0 1.6rem;font-size:1.05rem;opacity:.85;}
  section{margin-top:2.2rem;}
  section h2{margin:0 0 .6rem;font-size:1.35rem;font-weight:700;}
  ul{margin:0;padding-left:1.2rem;display:flex;flex-direction:column;gap:.35rem;}
  li{line-height:1.35;}
  .meta{display:flex;flex-wrap:wrap;gap:1rem;font-size:.95rem;opacity:.8;}
  .meta span{display:flex;flex-direction:column;}
  .meta span strong{font-size:1.1rem;color:#fefefe;}
  .meta span small{font-size:.85rem;opacity:.7;}
  .offline-note{margin-top:2rem;font-size:.9rem;opacity:.65;}
</style>
</head>
<body>
<div class="offline-wrap">
  <h1>Offline-Modus</h1>
  <p>Die zuletzt verfügbaren Plan- und Einstellungsdaten werden angezeigt, bis die Verbindung wiederhergestellt ist.</p>
  <section id="scheduleSection" hidden>
    <h2>Letzter Aufgussplan</h2>
    <ul id="scheduleList"></ul>
  </section>
  <section id="settingsSection" hidden>
    <h2>Geräteeinstellungen</h2>
    <div class="meta" id="settingsMeta"></div>
  </section>
  <p class="offline-note">Tipp: Stelle sicher, dass der Server erreichbar ist oder prüfe das Netzwerk, um Live-Daten zu erhalten.</p>
</div>
<script>
(async () => {
  if (!('caches' in window)) return;
  let cache = null;
  try {
    cache = await caches.open('signage-data-v1');
  } catch (error) {
    return;
  }
  if (!cache) return;

  async function loadJson(path){
    const response = await cache.match(path, { ignoreSearch: true });
    if (!response) return null;
    try {
      return await response.json();
    } catch (error) {
      return null;
    }
  }

  const schedule = await loadJson('/api/schedule.php');
  const settings = await loadJson('/api/settings.php');

  if (schedule) {
    const section = document.getElementById('scheduleSection');
    const list = document.getElementById('scheduleList');
    const saunas = Array.isArray(schedule.saunas) ? schedule.saunas : [];
    const rows = Array.isArray(schedule.rows) ? schedule.rows : [];
    const entries = [];
    rows.forEach((row) => {
      if (!row || typeof row !== 'object') return;
      const time = typeof row.time === 'string' ? row.time.trim() : '';
      const items = Array.isArray(row.entries) ? row.entries : [];
      const labels = [];
      items.forEach((cell, idx) => {
        if (!cell || typeof cell !== 'object') return;
        const name = saunas[idx] || '';
        const title = typeof cell.title === 'string' ? cell.title.trim() : '';
        if (!title) return;
        labels.push(name ? `${name}: ${title}` : title);
      });
      if (time && labels.length) entries.push({ time, labels });
    });
    entries.slice(0, 6).forEach(({ time, labels }) => {
      const item = document.createElement('li');
      item.textContent = `${time} – ${labels.join(' • ')}`;
      list.appendChild(item);
    });
    if (entries.length) section.hidden = false;
  }

  if (settings) {
    const meta = document.getElementById('settingsMeta');
    const section = document.getElementById('settingsSection');
    const layoutMode = settings.display?.layoutMode === 'split' ? 'Zweispaltig' : 'Einspaltig';
    const layoutProfile = settings.display?.layoutProfile || 'landscape';
    const activeStyle = settings.slides?.activeStyleSet || 'classic';
    const extras = settings.extras || {};
    const wellnessCount = Array.isArray(extras.wellnessTips) ? extras.wellnessTips.length : 0;
    const eventCount = Array.isArray(extras.eventCountdowns) ? extras.eventCountdowns.length : 0;
    const infoModules = Array.isArray(extras.infoModules) ? extras.infoModules : [];
    const infoCount = infoModules.reduce((count, entry) => {
      if (!entry || typeof entry !== 'object') return count;
      if (entry.enabled === false) return count;
      const text = typeof entry.text === 'string' ? entry.text.trim() : '';
      return text ? count + 1 : count;
    }, 0);

    const metaItems = [
      ['Layout', `${layoutMode} · Profil: ${layoutProfile}`],
      ['Style-Set', activeStyle],
      ['Wellness-Tipps', String(wellnessCount)],
      ['Events', String(eventCount)],
      ['Info-Banner', String(infoCount)]
    ];
    metaItems.forEach(([label, value]) => {
      const span = document.createElement('span');
      span.innerHTML = `<strong>${value}</strong><small>${label}</small>`;
      meta.appendChild(span);
    });
    section.hidden = false;
  }
})();
</script>
</body>
</html>

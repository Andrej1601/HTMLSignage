<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Aufguss â€“ Slideshow</title>
  <link rel="stylesheet" href="/assets/design.css">
  <link rel="stylesheet" href="/assets/responsive.css">
</head>
<body class="slideshow">
  <div id="fitbox" class="fitbox">
    <div id="canvas" class="canvas">
      <div id="stage" class="stage">
        <div id="stage-left" class="stage-area"></div>
        <div id="stage-right" class="stage-area"></div>
      </div>
      <div id="info-banner-area" class="info-banner-area" data-empty="true"></div>
    </div>
  </div>
  <script type="module">
    const manifestUrl = '/player/dist/manifest.json';

    (() => {
      const listeners = new Set();
      let lastMessage = null;

      function publish(message) {
        lastMessage = message;
        for (const listener of listeners) {
          try {
            listener(message);
          } catch (error) {
            console.error('[slideshow] preview listener failed', error);
          }
        }
      }

      const bridge = {
        subscribe(listener) {
          if (typeof listener !== 'function') {
            return () => {};
          }
          listeners.add(listener);
          if (lastMessage) {
            try {
              listener(lastMessage);
            } catch (error) {
              console.error('[slideshow] preview listener failed', error);
            }
          }
          return () => {
            listeners.delete(listener);
          };
        },
        publish,
      };

      try {
        window.__playerPreviewBridge = bridge;
      } catch (error) {
        console.error('[slideshow] failed to expose preview bridge', error);
      }

      window.addEventListener('message', (event) => {
        const data = event?.data;
        if (!data || data.type !== 'preview') {
          return;
        }
        publish(data);
      });

      return bridge;
    })();

    async function loadPlayer() {
      try {
        const response = await fetch(manifestUrl, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`manifest-${response.status}`);
        }

        const manifest = await response.json();
        const manifestValues = Object.values(manifest || {});
        const entry = manifestValues.find((item) => item && item.isEntry && typeof item.file === 'string');
        if (!entry) {
          throw new Error('entry-missing');
        }

        const basePath = '/player/dist/';
        if (Array.isArray(entry.css)) {
          for (const cssPath of entry.css) {
            if (typeof cssPath !== 'string' || cssPath === '') {
              continue;
            }
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = basePath + cssPath.replace(/^\/+/, '');
            document.head.appendChild(link);
          }
        }

        const scriptPath = entry.file.replace(/^\/+/, '');
        await import(basePath + scriptPath);
      } catch (error) {
        console.error('[slideshow] failed to bootstrap player bundle', error);
      }
    }

    loadPlayer();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
